<%namespace file='/theme-variables.html' import="get_global_settings" />
<%! from openedx.core.djangoapps.site_configuration.helpers import get_current_site_configuration, get_value %>

<%
  siteOrganization = get_value('course_org_filter');
  if user.is_authenticated():
    if show_intercom_widget:
      userType = 'Staff'
    else:
      userType = 'Learner'
    endif
  else:
    userType = 'Not authenticated'
  endif
  if course:
    courseName = "%s | %s" % (course.display_number_with_default, course.display_name_with_default)
  else:
    courseName = 'Not in course'
  endif
%>

% if (get_global_settings().get('customer_gtm_enabled') and (get_global_settings().get('customer_gtm_id') != "")):
  <%
    customerGtmId = get_global_settings().get('customer_gtm_id')
  %>
  <script>
    dataLayer = [{
      'visitorType': '${userType}',
      'courseName': '${courseName}'
    }];
  </script>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','${customerGtmId | n, js_escaped_string}');</script>
  <!-- End Google Tag Manager -->
% endif

% if SHOW_GOOGLE_ANALYTICS:
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', '${GOOGLE_ANALYTICS_APP_ID}', 'auto');
    %if USER_EMAIL_HASH:
      ga('set', 'userId', '${USER_EMAIL_HASH}');
      ga('set', 'dimension1', '${USER_EMAIL_HASH }');
    %endif
    ga('send', 'pageview');
  </script>
  <!-- End Google Analytics -->

  <!-- Add new Analytics system. Note: for now we'll be duplicating analytics while we're testing the new Analytics organisation. Once we're satisfied with how it works, we'll remove the old one and keep just the new one. -->
  <!--
    usedId: we keep a consistent userId in Analytics in order to keep tracking a single user properly
    Dimension1: Organisation
    Dimension2: LMS Visitor type
    Dimension3: Visited course name
    Dimension4: LMS or Studio
  -->

  <%
    appsemblerLmsTrackingCode = get_global_settings().get('appsembler_lms_tracking_code')
  %>

  <script>
    % if get_global_settings().get('appsembler_lms_tracking_code'):
      ga('create', '${appsemblerLmsTrackingCode}', 'auto', 'appsemblerLmsTracker');
      ga('appsemblerLmsTracker.send', 'pageview', {
        %if USER_EMAIL_HASH:
          'userId': '${USER_EMAIL_HASH}',
        %endif
        'dimension1': '${siteOrganization}',
        'dimension2': '${userType}',
        'dimension3': '${courseName}',
        'dimension4': 'LMS'
      });
    % endif
  </script>
  <!-- /new analytics -->
% endif


% if SHOW_MIXPANEL:
  <!-- Mixpanel -->
  <script type="text/javascript">(function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
  0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
  mixpanel.init("${MIXPANEL_APP_ID}");
  </script>
  <!-- End Mixpanel -->
% endif

% if False:
  <!-- Appcues code -->
  <script src="//fast.appcues.com/26227.js"></script>
  % if user.is_authenticated():
    <script>
        // NOTE: These values should be specific to the current user.
        Appcues.identify('${user.id }', { // Unique identifier for current user
            name: '${user.profile.name}', // Current user's name
            email: '${user.email}', // Current user's email
            created_at: ${request.user.date_joined.strftime("%s")},

            // Additional user properties.
            // is_trial: false,
            // plan: "enterprise"
        });
    </script>
  % else:
    <script>
      Appcues.anonymous();
    </script>
  % endif
  <!-- /Appcues code -->
% endif
